#!/bin/bash
set -e

echo "=== Configurando addons path (Community + Enterprise + Custom) ==="

# Clonar Enterprise si no existe
if [ ! -f /opt/odoo/enterprise.NO_TOKEN ] && [ ! -d /opt/odoo/enterprise/account_budget ]; then
    echo "ðŸ”„ Clonando Enterprise..."
    clone_enterprise
fi

# Configurar addons_path definitivo
COMMUNITY_PATH="/opt/odoo/odoo/addons"
ENTERPRISE_PATH="/opt/odoo/enterprise"  # â† SIN /addons
CUSTOM_PATH="${ADDONS_DIR}"

ADDONS_PATHS=()
[ -d "${COMMUNITY_PATH}" ] && ADDONS_PATHS+=("${COMMUNITY_PATH}")
[ -d "${ENTERPRISE_PATH}" ] && ADDONS_PATHS+=("${ENTERPRISE_PATH}")
[ -d "${CUSTOM_PATH}" ] && ADDONS_PATHS+=("${CUSTOM_PATH}")

FINAL_ADDONS_PATH=$(IFS=','; echo "${ADDONS_PATHS[*]}")

sed -i '/^addons_path/d' ${ODOO_RC}
echo "addons_path=${FINAL_ADDONS_PATH}" >> ${ODOO_RC}

# Contar mÃ³dulos Enterprise correctamente
ENTERPRISE_MODULES=$(find /opt/odoo/enterprise -name "__manifest__.py" -not -path "*/tests/*" | wc -l)
CUSTOM_MODULES=$(find ${CUSTOM_PATH} -name "__manifest__.py" 2>/dev/null | wc -l)

echo "âœ… ConfiguraciÃ³n:"
echo "  Community:  âœ… $(ls ${COMMUNITY_PATH}/ | wc -l) addons"
echo "  Enterprise: âœ… ${ENTERPRISE_MODULES} mÃ³dulos"
echo "  Custom:     âœ… ${CUSTOM_MODULES} mÃ³dulos"
echo ""
cat ${ODOO_RC}
