#!/bin/bash
set -e

# Script completo para ejecutar tests con coverage

echo "=========================================="
echo "  EJECUTANDO TESTS DE ODOO"
echo "=========================================="

# 1. Esperar PostgreSQL
echo ""
echo ">>> Paso 1: Verificando PostgreSQL..."
wait_for_postgres

# 2. Instalar addons
echo ""
echo ">>> Paso 2: Instalando addons..."
install_addons

# 3. Listar addons a probar
echo ""
echo ">>> Paso 3: Detectando addons a probar..."
ADDONS_TO_TEST=$(list_addons_to_test | tr '\n' ',' | sed 's/,$//')

if [ -z "$ADDONS_TO_TEST" ]; then
    echo "Error: No se encontraron addons para probar en ${ADDONS_DIR}"
    exit 1
fi

echo "Addons detectados: ${ADDONS_TO_TEST}"

# 4. Inicializar base de datos
echo ""
echo ">>> Paso 4: Inicializando base de datos..."
init_test_database

# 5. Instalar addons en la base de datos
echo ""
echo ">>> Paso 5: Instalando addons en base de datos..."
odoo -c ${ODOO_RC} -d ${PGDATABASE} -i ${ADDONS_TO_TEST} --stop-after-init --log-level=warn

# 6. Preparar coverage con configuraci√≥n profesional
echo ""
echo ">>> Paso 6: Preparando coverage profesional..."
COVERAGE_DIR=${COVERAGE_DIR:-/workspace/coverage_data}
rm -rf ${COVERAGE_DIR}/*
mkdir -p ${COVERAGE_DIR}/htmlcov

# 7. Ejecutar tests con coverage
echo ""
echo ">>> Paso 7: Ejecutando tests con coverage..."
export COVERAGE_FILE=${COVERAGE_DIR}/.coverage
coverage run \
    --source=${ADDONS_DIR} \
    --omit="*/tests/*,*/__manifest__.py,*/__init__.py" \
    $(which odoo) \
    -c ${ODOO_RC} \
    -d ${PGDATABASE} \
    -u ${ADDONS_TO_TEST} \
    --test-enable \
    --stop-after-init \
    --log-level=test

# 8. Generar TODOS los reportes
echo ""
echo ">>> Paso 8: Generando reportes m√∫ltiples..."
echo ""
echo "=== 1. Coverage Report (Texto Detallado) ==="
COVERAGE_FILE=${COVERAGE_DIR}/.coverage coverage report --show-missing

echo ""
echo "=== 2. Coverage XML (para CI/CD) ==="
COVERAGE_FILE=${COVERAGE_DIR}/.coverage coverage xml -o ${COVERAGE_DIR}/coverage.xml

echo ""
echo "=== 3. Coverage HTML (Interactivo) ==="
COVERAGE_FILE=${COVERAGE_DIR}/.coverage coverage html -d ${COVERAGE_DIR}/htmlcov
echo "üìä Reporte HTML: ${COVERAGE_DIR}/htmlcov/index.html"

echo ""
echo "=== 4. Verificaci√≥n de L√≠mites M√≠nimos ==="
COVERAGE_FILE=${COVERAGE_DIR}/.coverage coverage report --fail-under=80
if [ $? -ne 0 ]; then
    echo "‚ùå ERROR: Coverage por debajo del 80% m√≠nimo requerido"
    exit 1
fi

echo ""
echo "‚úÖ Coverage m√≠nimo OK (80%+)"
echo "üìà Total coverage: $(COVERAGE_FILE=${COVERAGE_DIR}/.coverage coverage report | tail -1 | awk '{print $4}')"
