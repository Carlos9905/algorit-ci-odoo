#!/bin/bash
set -e

echo "=========================================="
echo "  EJECUTANDO TESTS DE ODOO"
echo "=========================================="

# 1. Esperar PostgreSQL
echo ""
echo ">>> Paso 1: Verificando PostgreSQL..."
wait_for_postgres

# 2. Instalar addons
echo ""
echo ">>> Paso 2: Instalando addons..."
install_addons

# 3. Listar addons a probar
echo ""
echo ">>> Paso 3: Detectando addons..."
echo "   INCLUDE=${INCLUDE:-todos} EXCLUDE=${EXCLUDE:-ninguno}"
ADDONS_TO_TEST=$(list_addons_to_test | tr '\n' ',' | sed 's/,$//')
echo "   Addons: ${ADDONS_TO_TEST}"

# 4. Inicializar base de datos
echo ""
echo ">>> Paso 4: Inicializando base de datos..."
init_test_database

# 5. Instalar addons en la base de datos
echo ""
echo ">>> Paso 5: Instalando addons en base de datos..."
odoo -c ${ODOO_RC} -d ${PGDATABASE} -i ${ADDONS_TO_TEST} --stop-after-init --log-level=warn

# 6. Preparar coverage
echo ""
echo ">>> Paso 6: Preparando coverage..."
COVERAGE_DIR=${COVERAGE_DIR:-/workspace/coverage_data}
rm -rf ${COVERAGE_DIR}/*
mkdir -p ${COVERAGE_DIR}/htmlcov

# 7. Ejecutar tests con coverage (SIN .coveragerc)
echo ""
echo ">>> Paso 7: Ejecutando tests con coverage..."
export COVERAGE_FILE=${COVERAGE_DIR}/.coverage
export COVERAGE_NO_CONFIG=1  # â† IGNORA .coveragerc
coverage run \
    --source=${ADDONS_DIR} \
    --omit=*/tests/*,*/__manifest__.py,*/__init__.py \
    $(which odoo) \
    -c ${ODOO_RC} \
    -d ${PGDATABASE} \
    -u ${ADDONS_TO_TEST} \
    --test-enable \
    --stop-after-init \
    --log-level=test

# 8. Generar reportes
echo ""
echo ">>> Paso 8: Generando reportes..."
echo ""
echo "=== Coverage Report (Texto) ==="
COVERAGE_FILE=${COVERAGE_DIR}/.coverage coverage report --show-missing

echo ""
echo "=== Coverage XML ==="
COVERAGE_FILE=${COVERAGE_DIR}/.coverage coverage xml -o ${COVERAGE_DIR}/coverage.xml

echo ""
echo "=== Coverage HTML ==="
COVERAGE_FILE=${COVERAGE_DIR}/.coverage coverage html -d ${COVERAGE_DIR}/htmlcov
echo "ðŸ“Š Abrir: coverage_data/htmlcov/index.html"

echo ""
echo "=========================================="
echo "  TESTS COMPLETADOS EXITOSAMENTE"
echo "=========================================="
