#!/bin/bash
set -e

echo "üîê Verificando acceso Enterprise..."

if [ -z "$GITHUB_TOKEN" ]; then
    echo "‚ö†Ô∏è  GITHUB_TOKEN no configurado. Usando SOLO Community."
    touch /opt/odoo/enterprise.NO_TOKEN
    exit 0
fi

echo "üåê Probando acceso a ${ENTERPRISE_REPO_URL}..."
if ! curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
    "${ENTERPRISE_REPO_URL}" >/dev/null 2>&1; then
    echo "‚ùå Sin acceso a Enterprise. Usando SOLO Community."
    touch /opt/odoo/enterprise.NO_ACCESS
    exit 0
fi

echo "‚úÖ Acceso OK. Clonando Enterprise..."
rm -rf /opt/odoo/enterprise/*
git clone --depth 1 --branch ${ODOO_VERSION:-16.0} \
    "https://x-access-token:${GITHUB_TOKEN}@github.com/odoo/enterprise.git" \
    /opt/odoo/enterprise

echo "‚úÖ Enterprise clonado exitosamente"
echo "üìÅ M√≥dulos encontrados: $(find /opt/odoo/enterprise -name '__manifest__.py' -not -path '*/tests/*' | wc -l)"
