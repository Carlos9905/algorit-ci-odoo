#!/bin/bash
set -e

# Listar SOLO nombres de addons (estilo OCA) - SALIDA PURA

if [ ! -d "${ADDONS_DIR}" ]; then
    exit 1
fi

INCLUDE=${INCLUDE:-""}
EXCLUDE=${EXCLUDE:-""}

# Encontrar TODOS los addons v√°lidos
while IFS= read -r -d '' manifest; do
    addon_dir=$(dirname "$manifest")
    addon_name=$(basename "$addon_dir")
    
    # Filtrar INCLUDE
    if [ -n "$INCLUDE" ]; then
        SKIP_INCLUDE=true
        IFS=',' read -ra INCLUDE_LIST <<< "$INCLUDE"
        for include in "${INCLUDE_LIST[@]}"; do
            if [[ "$addon_name" == "$include" ]]; then
                SKIP_INCLUDE=false
                break
            fi
        done
        if [ "$SKIP_INCLUDE" = true ]; then
            continue
        fi
    fi
    
    # Filtrar EXCLUDE
    SKIP_EXCLUDE=false
    IFS=',' read -ra EXCLUDE_LIST <<< "$EXCLUDE"
    for exclude in "${EXCLUDE_LIST[@]}"; do
        if [[ "$addon_name" == "$exclude" ]]; then
            SKIP_EXCLUDE=true
            break
        fi
    done
    
    if [ "$SKIP_EXCLUDE" = false ]; then
        echo "$addon_name"
    fi
done < <(find "${ADDONS_DIR}" -name '__manifest__.py' -not -path '*/tests/*' -print0)
